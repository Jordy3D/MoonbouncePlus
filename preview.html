<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moonbounce Hat Preview</title>

    <link rel="icon" href="images/favicon.png" type="image/png" />

    <link rel="stylesheet" href="css/magic.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/preview.css">

    <script>
        var characters = [
            { file: 'image/character/Rollo.png', name: 'Rollo', hatOffset: 60, },
            { file: 'image/character/Devo.png', name: 'Devo', hatOffset: 44, },
            { file: 'image/character/Mr._Man.png', name: 'Mr. Man', hatOffset: 54, },
            { file: 'image/character/Bumpy.png', name: 'Bumpy', hatOffset: 47, },
            { file: 'image/character/Puff.png', name: 'Puff', hatOffset: 49, },
            { file: 'image/character/Pengu.png', name: 'Pengu', hatOffset: 60, },
        ]
    </script>
</head>

<body>
    <header></header>
    <main>
        <section>
            <div id="controls">
                <div class="input-group">
                    <input type="file" id="file" accept="image/*">
                </div>
                <div class="input-group">
                    <label for="scale">Scale</label>
                    <input type="range" id="scale" min="0.1" max="1.5" step="0.1" value="1">
                </div>
            </div>
            <div id="previews">
                <div class="offset-controls">
                    <!-- 6 sliders for each character offset -->
                    <input type="range" id="rolloHatOffset" min="0" max="100" step="1" value="60">
                    <input type="range" id="devoHatOffset" min="0" max="100" step="1" value="60">
                    <input type="range" id="mrmanHatOffset" min="0" max="100" step="1" value="60">
                    <input type="range" id="bumpyHatOffset" min="0" max="100" step="1" value="60">
                    <input type="range" id="puffHatOffset" min="0" max="100" step="1" value="60">
                    <input type="range" id="penguHatOffset" min="0" max="100" step="1" value="60">
                </div>
                <canvas id="preview"></canvas>
            </div>
            <div id="image-preview"></div>
            </div>
        </section>
    </main>

    <footer></footer>

    <script>
        const file = document.getElementById('file');
        const scale = document.getElementById('scale');
        const preview = document.getElementById('preview');
        const imagePreview = document.getElementById('image-preview');

        // get all the hat offset sliders
        const rolloHatOffset = document.getElementById('rolloHatOffset');
        const devoHatOffset = document.getElementById('devoHatOffset');
        const mrmanHatOffset = document.getElementById('mrmanHatOffset');
        const bumpyHatOffset = document.getElementById('bumpyHatOffset');
        const puffHatOffset = document.getElementById('puffHatOffset');
        const penguHatOffset = document.getElementById('penguHatOffset');

        // set the hat offset for each character to the stored value
        getHatOffsets();

        function getHatOffsets() {
            rolloHatOffset.value = localStorage.getItem('rolloHatOffset') || characters[0].hatOffset;
            devoHatOffset.value = localStorage.getItem('devoHatOffset') || characters[1].hatOffset;
            mrmanHatOffset.value = localStorage.getItem('mrmanHatOffset') || characters[2].hatOffset;
            bumpyHatOffset.value = localStorage.getItem('bumpyHatOffset') || characters[3].hatOffset;
            puffHatOffset.value = localStorage.getItem('puffHatOffset') || characters[4].hatOffset;
            penguHatOffset.value = localStorage.getItem('penguHatOffset') || characters[5].hatOffset;
        
            setHatOffsets();
        }

        function setHatOffsets() {
            characters[0].hatOffset = rolloHatOffset.value;
            characters[1].hatOffset = devoHatOffset.value;
            characters[2].hatOffset = mrmanHatOffset.value;
            characters[3].hatOffset = bumpyHatOffset.value;
            characters[4].hatOffset = puffHatOffset.value;
            characters[5].hatOffset = penguHatOffset.value;

            localStorage.setItem('rolloHatOffset', rolloHatOffset.value);
            localStorage.setItem('devoHatOffset', devoHatOffset.value);
            localStorage.setItem('mrmanHatOffset', mrmanHatOffset.value);
            localStorage.setItem('bumpyHatOffset', bumpyHatOffset.value);
            localStorage.setItem('puffHatOffset', puffHatOffset.value);
            localStorage.setItem('penguHatOffset', penguHatOffset.value);
        }

        // save the hat offset for each character to local storage
        rolloHatOffset.addEventListener('input', function () {
            setHatOffsets();
            renderCharacters(drawItemImage);
        });
        devoHatOffset.addEventListener('input', function () {
            setHatOffsets();
            renderCharacters(drawItemImage);
        });
        mrmanHatOffset.addEventListener('input', function () {
            setHatOffsets();
            renderCharacters(drawItemImage);
        });
        bumpyHatOffset.addEventListener('input', function () {
            setHatOffsets();
            renderCharacters(drawItemImage);
        });
        puffHatOffset.addEventListener('input', function () {
            setHatOffsets();
            renderCharacters(drawItemImage);
        });
        penguHatOffset.addEventListener('input', function () {
            setHatOffsets();
            renderCharacters(drawItemImage);
        });


        var verticalGap = 50;
        var horizontalGap = 20;
        var startHeight = 30;
        var characterSize = null;
        var characterPositions = [];

        var characterImges = [];

        function setCanvasSize(width, height) {
            preview.width = width;
            preview.height = height;
        }

        function drawImageToCanvas(image, position, size, clear = false) {
            const context = preview.getContext('2d');
            if (clear) {
                context.clearRect(0, 0, preview.width, preview.height);
            }
            if (image === null) {
                context.clearRect(position.x, position.y, size.width, size.height);
                return;
            }
            context.drawImage(image, position.x, position.y, size.width, size.height);
        }

        function roundToPowerOfTwo(value) {
            return Math.pow(2, Math.ceil(Math.log2(value)));
        }

        function renderCharacters(then) {
            // Clear the canvas
            drawImageToCanvas(null, { x: 0, y: 0 }, { width: preview.width, height: preview.height }, true);

            var width = preview.width;
            var height = preview.height;
            var size = (Math.min(width - 2 * horizontalGap, height - 2 * verticalGap) / 3);
            size = roundToPowerOfTwo(size);
            characterSize = size;
            startHeight = size;

            if (characterImges.length === 0) {
                console.log('Loading Character images for the first time');
                for (let i = 0; i < characters.length; i++) {
                    const image = new Image();
                    image.src = characters[i].file;
                    image.onload = function () {
                        const x = (i % 3) * (size + horizontalGap);
                        const y = Math.floor(i / 3) * (size + verticalGap) + startHeight;
                        drawImageToCanvas(image, { x: x, y: y }, { width: size, height: size });
                        characterPositions[i] = { x: x, y: y };
                    };
                    characterImges.push(image);
                }
            }
            else {
                console.log('Using cached Character images');
                for (let i = 0; i < characters.length; i++) {
                    const x = (i % 3) * (size + horizontalGap);
                    const y = Math.floor(i / 3) * (size + verticalGap) + startHeight;
                    drawImageToCanvas(characterImges[i], { x: x, y: y }, { width: size, height: size });
                    characterPositions[i] = { x: x, y: y };
                }
            }

            if (then) {
                then();
            }
        }

        setCanvasSize(256, 256);
        renderCharacters();

        file.addEventListener('click', function () {
            resetCanvas();
        });

        scale.addEventListener('input', function () {
            drawImageToCanvas(null, { x: 0, y: 0 }, { width: preview.width, height: preview.height }, true);
            renderCharacters(drawItemImage);
        });

        var image = new Image();

        file.addEventListener('change', function () {
            const fileObject = file.files[0];
            const reader = new FileReader();

            reader.addEventListener('load', function () {
                image = new Image();
                image.addEventListener('load', function () {
                    drawItemImage();
                });
                image.src = reader.result;

                const imagePreviewElement = new Image();
                imagePreviewElement.src = reader.result;
                imagePreview.innerHTML = '';
                imagePreview.appendChild(imagePreviewElement);
            });

            reader.readAsDataURL(fileObject);
        });

        function drawItemImage() {
            for (let i = 0; i < characters.length; i++) {
                const character = characters[i];
                const size = characterSize * scale.value;
                const hatPosCalculated = {
                    x: characterPositions[i].x + (characterSize / 2) - (size / 2),
                    y: characterPositions[i].y - character.hatOffset * scale.value
                };
                drawImageToCanvas(image, { x: hatPosCalculated.x, y: hatPosCalculated.y }, { width: size, height: size });
            }
        }

        function resetCanvas() {
            drawImageToCanvas(null, { x: 0, y: 0 }, { width: preview.width, height: preview.height }, true);
            renderCharacters();
            imagePreview.innerHTML = '';
        }
    </script>
</body>

</html>